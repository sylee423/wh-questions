<!DOCTYPE html>
<html>
<head>
    <title>Laboratory Decision Study</title>
    <script src="https://unpkg.com/jspsych@8.0.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@2.0.0"></script>
    <link href="https://unpkg.com/jspsych@8.0.2/css/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="styles.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    <script src="shared.js"></script>
</head>
<body></body>
<script>
// =============================================================================
// CONFIGURATION AND SETUP
// =============================================================================

// Get URL parameters
const urlParams = new URLSearchParams(window.location.search);
const prolificPID = urlParams.get('PROLIFIC_PID') || 'unknown';
const studyID = urlParams.get('STUDY_ID') || 'unknown';
const sessionID = urlParams.get('SESSION_ID') || 'unknown';

// Experiment 2: Goal (between-subjects) x Decision Structure (between-subjects)
const expVersion = 'exp2';

// Condition assignment (can be set via URL or random)
let goalCondition = urlParams.get('goal') || null;  // 'uncont' or 'cont'
let decisionStructure = urlParams.get('structure') || null;  // 'singleton' or 'set_id'

// Random assignment if not specified
if (!goalCondition) {
    goalCondition = Math.random() < 0.5 ? 'uncont' : 'cont';
}

if (!decisionStructure) {
    decisionStructure = Math.random() < 0.5 ? 'singleton' : 'set_id';
}

// Test mode - skip button delays for faster testing
const testMode = urlParams.get('testMode') === 'true';
const buttonDisableTime = testMode ? 100 : 2000;

// Number of vials (10, identical to exp1)
const nVials = 10;

// Base Rate (fixed as 0.5 for exp2)
const base_rate_const = 0.5;

// Question options for forced choice
const questionOptions = [
    "Which vials are contaminated?",
    "Which vials are not contaminated?"
];

// =============================================================================
// EXPERIMENT-SPECIFIC HELPERS
// =============================================================================

// Consolidated goal configuration
function getGoalConfig() {
    const configs = {
        singleton: {
            uncont: {
                text: 'Run the experiment successfully',
                icon: '‚úì',
                cssClass: 'uncont-goal'
            },
            cont: {
                text: 'Identify the contaminant',
                icon: '‚ö†',
                cssClass: 'cont-goal'
            }
        },
        set_id: {
            uncont: {
                text: 'Sort all vials. Dr. Smith will use vials from <strong>"Safe to Use"</strong> for an experiment tomorrow',
                icon: 'üî¨',
                cssClass: 'uncont-goal'
            },
            cont: {
                text: 'Sort all vials. A safety inspector will examine <strong>"Dispose"</strong> to verify proper handling',
                icon: 'üìã',
                cssClass: 'cont-goal'
            }
        }
    };
    return configs[decisionStructure][goalCondition];
}

// =============================================================================
// JSPSYCH INITIALIZATION
// =============================================================================

const jsPsych = initJsPsych({
    on_finish: function() {
        const finalData = {
            prolific_pid: prolificPID,
            study_id: studyID,
            session_id: sessionID,
            exp_version: expVersion,
            goal_condition: goalCondition,
            decision_structure: decisionStructure,
            trials: jsPsych.data.get().values(),
            completion_time: new Date().toISOString()
        };
        showCompletionScreen(jsPsych, finalData, 'WHQPOL2024', prolificPID);
    }
});

// =============================================================================
// TIMELINE CONSTRUCTION
// =============================================================================

let timeline = [];

// -----------------------------------------------------------------------------
// WELCOME AND CONSENT
// -----------------------------------------------------------------------------

const welcome = {
    type: jsPsychHtmlButtonResponse,
    stimulus: CONSENT_HTML,
    choices: ['Continue'],
    data: { trial_type: 'consent' }
};
timeline.push(welcome);

// -----------------------------------------------------------------------------
// VISUAL INSTRUCTIONS (5 pages)
// -----------------------------------------------------------------------------

function getVisualInstructionPages() {
    const pages = [];

    // Page 1: Your Lab Bench
    pages.push(`
        <div class="instruction-container fade-in">
            <h2 class="instruction-title">üß™ Your Lab Bench</h2>
            <p class="instruction-text">You work in a laboratory with chemical solutions stored in vials.</p>
            ${renderVialRack(nVials)}
            <p class="instruction-text">You have <strong>${nVials} vials</strong> on your bench.</p>
        </div>
    `);

    // Page 2: The Problem
    pages.push(`
        <div class="instruction-container fade-in">
            <h2 class="instruction-title">‚ö†Ô∏è The Problem</h2>
            <p class="instruction-text">While you were taking a break outside, ${base_rate_const * nVials} of the vials got contaminated,
                while ${nVials - (base_rate_const * nVials)} were left intact.</p>
            ${renderVialRack(nVials, states = ['safe', 'danger', 'danger', 'danger', 'safe', 'safe', 'safe', 'danger', 'safe', 'danger'])}
            <p class="instruction-text">But you can't tell which is which just by looking!</p>
        </div>
    `);


    // Page 3: Your Goal (different for UNCONT vs CONT, singleton vs set_id)
    if (decisionStructure === 'singleton') {
        if (goalCondition === 'uncont') {
            pages.push(`
                <div class="instruction-container fade-in">
                    <h2 class="instruction-title">üéØ Your Goal</h2>
                    <p class="instruction-text">Your goal is to run your experiment on an <strong>uncontaminated</strong> vial. 
                    You must pick <strong>ONE</strong> vial to use.</p>
                    <div class="outcome-demo">
                        <div class="outcome-box success">
                            <div class="outcome-icon">‚úì</div>
                            ${renderVial('', 'safe', false)}
                            <div class="outcome-label">Success!</div>
                            <p style="font-size: 14px; margin: 5px 0;">Picked a safe vial</p>
                        </div>
                        <div class="outcome-box failure">
                            <div class="outcome-icon">üò¢</div>
                            ${renderVial('', 'danger', false)}
                            <div class="outcome-label">Failure!</div>
                            <p style="font-size: 14px; margin: 5px 0;">Sample ruined</p>
                        </div>
                    </div>
                    <div class="goal-card uncont-goal">
                        <span class="icon">‚úì</span>
                        <span><strong>Your Goal:</strong> Do experiment with an uncontaminated vial</span>
                    </div>
                </div>
            `);
        } else {
            pages.push(`
                <div class="instruction-container fade-in">
                    <h2 class="instruction-title">üéØ Your Goal</h2>
                    <p class="instruction-text">Your goal is to find out the contaminant by examining a <strong>contaminated</strong> vial. 
                    You must pick <strong>ONE vial</strong> to examine.</p>
                    <div class="outcome-demo">
                        <div class="outcome-box failure">
                            <div class="outcome-icon">üò¢</div>
                            ${renderVial('', 'safe', false)}
                            <div class="outcome-label">Failure!</div>
                            <p style="font-size: 14px; margin: 5px 0;">Still in the dark!</p>
                        </div>
                        <div class="outcome-box success">
                            <div class="outcome-icon">‚úì</div>
                            ${renderVial('', 'danger', false)}
                            <div class="outcome-label">Success!</div>
                            <p style="font-size: 14px; margin: 5px 0;">Contaminant identified!</p>
                        </div>
                    </div>
                    <div class="goal-card cont-goal">
                        <span class="icon">‚ö†</span>
                        <span><strong>Your Goal:</strong> Find out the contaminant in a contaminated vial</span>
                    </div>
                </div>
            `);
        }
    } else {
        // set_id condition
        if (goalCondition === 'uncont') {
            pages.push(`
                <div class="instruction-container fade-in">
                    <h2 class="instruction-title">üéØ Your Task</h2>
                    <p class="instruction-text">You need to find as many <strong>uncontaminated</strong> samples as possible for an experiment.</p>
                    <div class="sorting-demo">
                        <div class="sorting-bin safe-bin">
                            <div class="bin-icon">üî¨</div>
                            <div class="bin-label">Safe to Use</div>
                        </div>
                        <div class="sorting-bin dispose-bin">
                            <div class="bin-icon">üóë</div>
                            <div class="bin-label">Dispose</div>
                        </div>
                    </div>
                    <div class="goal-card uncont-goal">
                        <span class="icon">üî¨</span>
                        <span><strong>Dr. Smith</strong> will use the vials from "Safe to Use" for an important experiment tomorrow.</span>
                    </div>
                    <p class="instruction-text">Your score depends on how well the experiment goes!</p>
                </div>
            `);
        } else {
            pages.push(`
                <div class="instruction-container fade-in">
                    <h2 class="instruction-title">üéØ Your Task</h2>
                    <p class="instruction-text">You need to remove as many <strong>contaminated</strong> vials as possible.</p>
                    <div class="sorting-demo">
                        <div class="sorting-bin safe-bin">
                            <div class="bin-icon">üî¨</div>
                            <div class="bin-label">Safe to use</div>
                        </div>
                        <div class="sorting-bin dispose-bin">
                            <div class="bin-icon">üìã</div>
                            <div class="bin-label">Dispose</div>
                        </div>
                    </div>
                    <div class="goal-card cont-goal">
                        <span class="icon">üìã</span>
                        <span><strong>A safety inspector</strong> will examine "Dispose" to make sure hazardous materials were properly removed.</span>
                    </div>
                    <p class="instruction-text">Your score depends on how well you removed the contaminated vials!</p>
                </div>
            `);
        }
    }

    // Page 4: Your Assistant
    pages.push(`
        <div class="instruction-container fade-in">
            <h2 class="instruction-title">üî¨ Your Lab Assistant</h2>
            <div class="assistant-avatar">üë®‚Äçüî¨</div>
            <p class="instruction-text">Your lab assistant was in the lab. </p>
            <p class="instruction-text">They saw the contamination happen, 
                even though they're not completely sure which are contaminated and which are not.</p>
            <div class="partial-knowledge-demo">
                <div class="knowledge-column">
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        ${renderVial('', 'danger', false)}
                        ${renderVial('', 'safe', false)}
                        ${renderVial('', 'safe', false)}
                        ${renderVial('', 'unknown', false)}
                        ${renderVial('', 'danger', false)}
                        ${renderVial('', 'unknown', false)}
                        ${renderVial('', 'danger', false)}
                    </div>
                    <p style="font-size: 14px; color: #666;">Assistant knows about some but not all the vials</p>
                </div>
            </div>
        </div>
    `);


    // Page 5: Your Question Choice
    pages.push(`
        <div class="instruction-container fade-in">
            <h2 class="instruction-title">‚ùì Your Question</h2>
            <p class="instruction-text">Before deciding, you can ask your assistant <strong>ONE</strong> of two questions:</p>
            <div style="display: flex; justify-content: center; gap: 20px; margin: 25px 0; flex-wrap: wrap;">
                <div class="question-btn" style="cursor: default;">
                    "Which vials are <strong style="color: var(--danger-color);">contaminated</strong>?"
                </div>
                <div class="question-btn" style="cursor: default;">
                    "Which vials are <strong style="color: var(--safe-color);">not contaminated</strong>?"
                </div>
            </div>
            <p class="instruction-text">Think about which question would give you the most useful information for <strong>your goal</strong>.</p>
            <div class="instruction-emphasis">
                You'll complete <strong>1 trial</strong>.
            </div>
        </div>
    `);

    return pages;
}

const instructions = {
    type: jsPsychInstructions,
    pages: getVisualInstructionPages(),
    show_clickable_nav: true,
    button_label_previous: 'Back',
    button_label_next: 'Next',
    data: { trial_type: 'instructions' }
};
timeline.push(instructions);

// -----------------------------------------------------------------------------
// COMPREHENSION CHECKS (using shared functions)
// -----------------------------------------------------------------------------

timeline.push(createComprehensionCheck1(jsPsych, goalCondition, decisionStructure));
timeline.push(createComprehensionCheck2(jsPsych));

// -----------------------------------------------------------------------------
// TRIAL STIMULUS HELPER
// -----------------------------------------------------------------------------

function createTrialStimulus() {
    const baseRate = 0.5;  // Fixed at 50% for exp2
    return `
        <div class="trial-container">
            ${renderVialRack(nVials)}
            <div class="goal-card ${getGoalConfig().cssClass}">
                <span class="icon">${getGoalConfig().icon}</span>
                <span><strong>Your Goal:</strong> ${getGoalConfig().text}</span>
            </div>
            <div class="question-prompt">
                You ask your assistant:
            </div>
        </div>
    `;
}

// -----------------------------------------------------------------------------
// MAIN EXPERIMENTAL TRIAL (single trial for exp2)
// -----------------------------------------------------------------------------

let mainTrialButtonOrder = [];

const mainTrial = {
    type: jsPsychHtmlButtonResponse,
    stimulus: createTrialStimulus(),
    choices: questionOptions,
    on_start: function(trial) {
        mainTrialButtonOrder = jsPsych.randomization.shuffle([...questionOptions]);
        trial.choices = mainTrialButtonOrder;
    },
    data: {
        trial_type: 'main_trial',
        trial_id: 'exp2_trial1',
        base_rate: 0.5,
        exp_version: expVersion,
        goal_condition: goalCondition,
        decision_structure: decisionStructure
    },
    on_finish: function(data) {
        data.button_order = [...mainTrialButtonOrder];
        data.chosen_question = mainTrialButtonOrder[data.response];
        data.chose_which_contaminated = data.chosen_question === "Which vials are contaminated?";
        data.chose_which_uncontaminated = data.chosen_question === "Which vials are not contaminated?";
    },
    button_html: (choice) => `<button class="jspsych-btn" style="min-width: 300px;">${choice}</button>`,
    on_load: function() { disableButtonsTemporarily(buttonDisableTime); }
};
timeline.push(mainTrial);

// -----------------------------------------------------------------------------
// POST-TASK QUESTIONS
// -----------------------------------------------------------------------------

const strategyProbe = {
    type: jsPsychSurveyText,
    questions: [
        {
            prompt: '<h3>Strategy Question</h3><p>How did you decide which question to ask? Please describe your reasoning or strategy:</p>',
            name: 'strategy',
            rows: 5,
            columns: 60,
            required: true
        }
    ],
    data: { trial_type: 'strategy_probe' }
};
timeline.push(strategyProbe);

// -----------------------------------------------------------------------------
// DEBRIEF
// -----------------------------------------------------------------------------

const debrief = {
    type: jsPsychHtmlButtonResponse,
    stimulus: DEBRIEF_HTML,
    choices: ['Finish and Get Completion Code'],
    data: { trial_type: 'debrief' }
};
timeline.push(debrief);

const subject_id = jsPsych.randomization.randomID(10);
const filename = `${subject_id}.csv`;

const save_data = {
    type: jsPsychPipe,
    action: "save",
    experiment_id: "MHtAinSyk6ns",
    filename: filename,
    data_string: ()=>jsPsych.data.get().csv()
};                       
timeline.push(save_data);	
// =============================================================================
// RUN EXPERIMENT
// =============================================================================

jsPsych.run(timeline);

</script>
</html>
