<!DOCTYPE html>
<html>
<head>
    <title>Laboratory Decision Study</title>
    <script src="https://unpkg.com/jspsych@8.0.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@2.0.0"></script>
    <link href="https://unpkg.com/jspsych@8.0.2/css/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="styles.css" rel="stylesheet" type="text/css" />
</head>
<body></body>
<script>
// =============================================================================
// CONFIGURATION AND SETUP
// =============================================================================

// Get URL parameters
const urlParams = new URLSearchParams(window.location.search);
const prolificPID = urlParams.get('PROLIFIC_PID') || 'unknown';
const studyID = urlParams.get('STUDY_ID') || 'unknown';
const sessionID = urlParams.get('SESSION_ID') || 'unknown';

// Experiment 2: Goal (between-subjects) x Decision Structure (between-subjects)
const expVersion = 'exp2';

// Condition assignment (can be set via URL or random)
let goalCondition = urlParams.get('goal') || null;  // 'find' or 'avoid'
let decisionStructure = urlParams.get('structure') || null;  // 'singleton' or 'set_id'

// Random assignment if not specified
if (!goalCondition) {
    goalCondition = Math.random() < 0.5 ? 'find' : 'avoid';
}

if (!decisionStructure) {
    decisionStructure = Math.random() < 0.5 ? 'singleton' : 'set_id';
}

// Test mode - skip button delays for faster testing
const testMode = urlParams.get('testMode') === 'true';
const buttonDisableTime = testMode ? 100 : 2000;

// Number of vials (4 for exp2)
const nVials = 4;

// Question options for forced choice
const questionOptions = [
    "Which vials are contaminated?",
    "Which vials are uncontaminated?"
];

// =============================================================================
// VIAL RENDERING HELPERS
// =============================================================================

function renderVial(id, state = 'unknown', showLabel = true) {
    // state: 'unknown', 'safe', 'danger'
    const testedClass = (state === 'safe' || state === 'danger') ? 'tested' : '';
    return `
        <div class="vial-container">
            <div class="vial ${state} ${testedClass}">
                <div class="vial-body">
                    <div class="vial-liquid"></div>
                </div>
                <div class="vial-status"></div>
            </div>
            ${showLabel ? `<div class="vial-label">${id}</div>` : ''}
        </div>
    `;
}

function renderVialRack(states = null, n = nVials) {
    // states: array of 'unknown'|'safe'|'danger', or null for all unknown
    if (!states) {
        states = Array(n).fill('unknown');
    }
    const vials = states.map((state, i) => renderVial(i + 1, state)).join('');
    return `<div class="vial-rack">${vials}</div>`;
}

// =============================================================================
// STIMULUS TEXT CONFIGURATIONS
// =============================================================================

function renderProportionBar() {
    const baseRate = 0.5;  // Fixed at 50% for exp2
    const nContaminated = Math.round(baseRate * nVials);
    const nSafe = nVials - nContaminated;
    const contaminatedPct = baseRate * 100;
    const safePct = 100 - contaminatedPct;

    return `
        <div class="proportion-container">
            <div class="proportion-label">Expected contamination rate:</div>
            <div class="proportion-bar">
                <div class="proportion-segment contaminated" style="width: ${contaminatedPct}%;">
                    ${nContaminated > 0 ? `${nContaminated} ‚ò†` : ''}
                </div>
                <div class="proportion-segment safe" style="width: ${safePct}%;">
                    ${nSafe > 0 ? `${nSafe} ‚úì` : ''}
                </div>
            </div>
            <div class="proportion-legend">
                <div class="legend-item">
                    <div class="legend-dot contaminated"></div>
                    <span>Contaminated (${nContaminated})</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot safe"></div>
                    <span>Safe (${nSafe})</span>
                </div>
            </div>
        </div>
    `;
}

// Consolidated goal configuration
function getGoalConfig() {
    const configs = {
        singleton: {
            find: {
                text: 'Find a <strong>safe</strong> vial to use',
                icon: '‚úì',
                cssClass: 'find-goal'
            },
            avoid: {
                text: 'Avoid picking a <strong>contaminated</strong> vial',
                icon: '‚ö†',
                cssClass: 'avoid-goal'
            }
        },
        set_id: {
            find: {
                text: 'Sort all vials. Dr. Smith will use vials from <strong>"Safe to Use"</strong> for an experiment tomorrow',
                icon: 'üî¨',
                cssClass: 'find-goal'
            },
            avoid: {
                text: 'Sort all vials. A safety inspector will examine <strong>"Dispose"</strong> to verify proper handling',
                icon: 'üìã',
                cssClass: 'avoid-goal'
            }
        }
    };
    return configs[decisionStructure][goalCondition];
}

// Reusable button disable function
function disableButtonsTemporarily(duration = buttonDisableTime) {
    const buttons = document.querySelectorAll('.jspsych-btn');
    buttons.forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
    });
    setTimeout(() => {
        buttons.forEach(btn => {
            btn.disabled = false;
            btn.style.opacity = '1';
        });
    }, duration);
}

// =============================================================================
// JSPSYCH INITIALIZATION
// =============================================================================

const jsPsych = initJsPsych({
    on_finish: function() {
        // Compile final data
        const finalData = {
            prolific_pid: prolificPID,
            study_id: studyID,
            session_id: sessionID,
            exp_version: expVersion,
            goal_condition: goalCondition,
            decision_structure: decisionStructure,
            trials: jsPsych.data.get().values(),
            completion_time: new Date().toISOString()
        };

        // Create downloadable data blob
        const dataBlob = new Blob([JSON.stringify(finalData, null, 2)], {type: 'application/json'});
        const dataUrl = URL.createObjectURL(dataBlob);

        // Display completion code for Prolific
        const completionCode = 'WHQPOL2024';
        jsPsych.getDisplayElement().innerHTML = `
            <div style="text-align: center; padding: 50px;">
                <h2>Thank you for completing the study!</h2>
                <p>Your completion code is:</p>
                <h1 style="background: #f0f0f0; padding: 20px; border-radius: 10px;">${completionCode}</h1>
                <p>Please copy this code and paste it into Prolific to receive your payment.</p>
                <p style="margin-top: 30px; color: #666;">You may now close this window.</p>
                <p style="margin-top: 20px;">
                    <a href="${dataUrl}" download="wh_questions_data_${prolificPID}_${Date.now()}.json"
                       style="color: #666; font-size: 12px;">[Download data (for testing)]</a>
                </p>
            </div>
        `;

        // Log data to console (in production, send to server)
        console.log('Final experiment data:', JSON.stringify(finalData, null, 2));
    }
});

// =============================================================================
// TIMELINE CONSTRUCTION
// =============================================================================

let timeline = [];

// -----------------------------------------------------------------------------
// WELCOME AND CONSENT
// -----------------------------------------------------------------------------

const welcome = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <h2 style="text-align: center;">STANFORD UNIVERSITY</h2>
        <h3 style="text-align: center;">Research Information Sheet</h3>
        <div class="instructions-box" style="font-size: 15px; line-height: 1.5;">
            <p><strong>Protocol Director:</strong> Robert Hawkins<br>
            <strong>Protocol Title:</strong> Communication and social cognition in natural audiovisual contexts<br>
            <strong>IRB#</strong> 77226</p>

            <p><strong>DESCRIPTION:</strong> You are invited to participate in a research study about language and communication. The purpose of the research is to understand how people formulate questions to gather information in uncertain situations. This research will be conducted through the Prolific platform, including participants from the US, UK, and Canada.</p>

            <p><strong>TIME INVOLVEMENT:</strong> The task will last the amount of time advertised on Prolific. You are free to withdraw from the study at any time.</p>

            <p><strong>RISKS AND BENEFITS:</strong> Study data will be stored securely, in compliance with Stanford University standards, minimizing the risk of confidentiality breach. This study advances our scientific understanding of how people communicate and make decisions. We cannot and do not guarantee or promise that you will receive any benefits from this study.</p>

            <p><strong>PAYMENTS:</strong> You will receive payment in the amount advertised on Prolific. If you do not complete this study, you will receive prorated payment based on the time that you have spent.</p>

            <p><strong>PARTICIPANT'S RIGHTS:</strong> If you have read this form and have decided to participate in this project, please understand your participation is voluntary and you have the right to withdraw your consent or discontinue participation at any time without penalty or loss of benefits to which you are otherwise entitled. The alternative is not to participate. You have the right to refuse to answer particular questions. The results of this research study may be presented at scientific or professional meetings or published in scientific journals. Your individual privacy will be maintained in all published and written data resulting from the study. In accordance with scientific norms, the data from this study may be used or shared with other researchers for future research (after removing personally identifying information) without additional consent from you.</p>

            <p><strong>CONTACT INFORMATION:</strong><br>
            <em>Questions:</em> If you have any questions, concerns or complaints about this research, its procedures, risks and benefits, contact the Protocol Director, Robert Hawkins (rdhawkins@stanford.edu).<br><br>
            <em>Independent Contact:</em> If you are not satisfied with how this study is being conducted, or if you have any concerns, complaints, or general questions about the research or your rights as a participant, please contact the Stanford Institutional Review Board (IRB) to speak to someone independent of the research team at 650-723-2480 or toll free at 1-866-680-2906, or email at irb2-manager@stanford.edu. You can also write to the Stanford IRB, Stanford University, 1705 El Camino Real, Palo Alto, CA 94306.</p>

            <p style="text-align: center; margin-top: 20px;"><strong>Please save or print a copy of this page for your records.<br>If you agree to participate in this research, please click "Continue".</strong></p>
        </div>
    `,
    choices: ['Continue'],
    data: { trial_type: 'consent' }
};
timeline.push(welcome);

// -----------------------------------------------------------------------------
// VISUAL INSTRUCTIONS (5 pages)
// -----------------------------------------------------------------------------

function getVisualInstructionPages() {
    const pages = [];

    // Page 1: Your Lab Bench
    pages.push(`
        <div class="instruction-container fade-in">
            <h2 class="instruction-title">üß™ Your Lab Bench</h2>
            <p class="instruction-text">You work in a laboratory with biological samples stored in vials.</p>
            ${renderVialRack()}
            <p class="instruction-text">You have <strong>${nVials} vials</strong> on your bench.</p>
            <p class="instruction-text" style="color: #666;">Currently, you don't know which are safe to use...</p>
        </div>
    `);

    // Page 2: The Problem
    pages.push(`
        <div class="instruction-container fade-in">
            <h2 class="instruction-title">‚ö†Ô∏è The Problem</h2>
            <p class="instruction-text">Some vials are <strong style="color: var(--safe-color);">safe</strong> (uncontaminated) and some are <strong style="color: var(--danger-color);">contaminated</strong> (dangerous).</p>
            <p class="instruction-text">But you can't tell which is which just by looking!</p>
            <div style="display: flex; justify-content: center; gap: 40px; margin: 30px 0;">
                <div style="text-align: center;">
                    ${renderVial('', 'safe', false)}
                    <div style="margin-top: 10px; color: var(--safe-color); font-weight: bold;">Safe ‚úì</div>
                </div>
                <div style="text-align: center;">
                    ${renderVial('', 'danger', false)}
                    <div style="margin-top: 10px; color: var(--danger-color); font-weight: bold;">Contaminated ‚ò†</div>
                </div>
                <div style="text-align: center;">
                    ${renderVial('', 'unknown', false)}
                    <div style="margin-top: 10px; color: var(--unknown-color); font-weight: bold;">Unknown ?</div>
                </div>
            </div>
            <p class="instruction-text">You need to figure out which vials are which before making your decision.</p>
        </div>
    `);

    // Page 3: Your Assistant
    pages.push(`
        <div class="instruction-container fade-in">
            <h2 class="instruction-title">üî¨ Your Lab Assistant</h2>
            <div class="assistant-avatar">üë®‚Äçüî¨</div>
            <p class="instruction-text">You have a lab assistant who can help. You can ask them <strong>ONE question</strong>.</p>
            <div class="instruction-emphasis">
                <strong>Important:</strong> Your assistant has tested <strong>some</strong> vials, but <strong>not all</strong> of them!
            </div>
            <div class="partial-knowledge-demo">
                <div class="knowledge-column">
                    <h4>Tested</h4>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        ${renderVial('', 'safe', false)}
                        ${renderVial('', 'danger', false)}
                    </div>
                    <p style="font-size: 14px; color: #666;">Assistant knows these</p>
                </div>
                <div class="knowledge-column">
                    <h4>Not Tested</h4>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        ${renderVial('', 'unknown', false)}
                        ${renderVial('', 'unknown', false)}
                        ${renderVial('', 'unknown', false)}
                    </div>
                    <p style="font-size: 14px; color: #666;">Assistant doesn't know these</p>
                </div>
            </div>
            <p class="instruction-text">They can only tell you about vials they've tested.</p>
        </div>
    `);

    // Page 4: Your Goal (different for FIND vs AVOID, singleton vs set_id)
    if (decisionStructure === 'singleton') {
        if (goalCondition === 'find') {
            pages.push(`
                <div class="instruction-container fade-in">
                    <h2 class="instruction-title">üéØ Your Goal</h2>
                    <p class="instruction-text">Your experiment needs a clean sample. You must pick <strong>ONE vial</strong> to use.</p>
                    <div class="outcome-demo">
                        <div class="outcome-box success">
                            <div class="outcome-icon">‚úì</div>
                            ${renderVial('', 'safe', false)}
                            <div class="outcome-label">Success!</div>
                            <p style="font-size: 14px; margin: 5px 0;">Picked a safe vial</p>
                        </div>
                        <div class="outcome-box failure">
                            <div class="outcome-icon">üí•</div>
                            ${renderVial('', 'danger', false)}
                            <div class="outcome-label">Failure!</div>
                            <p style="font-size: 14px; margin: 5px 0;">Sample ruined</p>
                        </div>
                    </div>
                    <div class="goal-card find-goal">
                        <span class="icon">‚úì</span>
                        <span><strong>Your Goal:</strong> Find an uncontaminated vial to use</span>
                    </div>
                </div>
            `);
        } else {
            pages.push(`
                <div class="instruction-container fade-in">
                    <h2 class="instruction-title">üéØ Your Goal</h2>
                    <p class="instruction-text">Contaminated vials are <strong>dangerous</strong>‚Äîthey'll destroy your equipment!</p>
                    <p class="instruction-text">You must pick <strong>ONE vial</strong> carefully.</p>
                    <div class="outcome-demo">
                        <div class="outcome-box success">
                            <div class="outcome-icon">‚úì</div>
                            ${renderVial('', 'safe', false)}
                            <div class="outcome-label">Safe!</div>
                            <p style="font-size: 14px; margin: 5px 0;">Equipment intact</p>
                        </div>
                        <div class="outcome-box failure">
                            <div class="outcome-icon">üí•</div>
                            ${renderVial('', 'danger', false)}
                            <div class="outcome-label">Disaster!</div>
                            <p style="font-size: 14px; margin: 5px 0;">Equipment destroyed!</p>
                        </div>
                    </div>
                    <div class="goal-card avoid-goal">
                        <span class="icon">‚ö†</span>
                        <span><strong>Your Goal:</strong> Avoid picking a contaminated vial</span>
                    </div>
                </div>
            `);
        }
    } else {
        // set_id condition
        if (goalCondition === 'find') {
            pages.push(`
                <div class="instruction-container fade-in">
                    <h2 class="instruction-title">üéØ Your Task</h2>
                    <p class="instruction-text">You need to <strong>SORT all vials</strong> into two bins.</p>
                    <div class="sorting-demo">
                        <div class="sorting-bin safe-bin">
                            <div class="bin-icon">‚úì</div>
                            <div class="bin-label">Safe to Use</div>
                        </div>
                        <div class="sorting-bin dispose-bin">
                            <div class="bin-icon">üóë</div>
                            <div class="bin-label">Dispose</div>
                        </div>
                    </div>
                    <div class="goal-card find-goal">
                        <span class="icon">üî¨</span>
                        <span><strong>Dr. Smith</strong> will use vials from "Safe to Use" for an important experiment tomorrow.</span>
                    </div>
                    <p class="instruction-text">Your score depends on how well the experiment goes!</p>
                </div>
            `);
        } else {
            pages.push(`
                <div class="instruction-container fade-in">
                    <h2 class="instruction-title">üéØ Your Task</h2>
                    <p class="instruction-text">You need to <strong>SORT all vials</strong> into two bins.</p>
                    <div class="sorting-demo">
                        <div class="sorting-bin safe-bin">
                            <div class="bin-icon">‚úì</div>
                            <div class="bin-label">Safe to Use</div>
                        </div>
                        <div class="sorting-bin dispose-bin">
                            <div class="bin-icon">‚ò†</div>
                            <div class="bin-label">Dispose</div>
                        </div>
                    </div>
                    <div class="goal-card avoid-goal">
                        <span class="icon">üìã</span>
                        <span><strong>A safety inspector</strong> will examine "Dispose" to verify hazardous materials were properly identified.</span>
                    </div>
                    <p class="instruction-text">Your score depends on the inspection results!</p>
                </div>
            `);
        }
    }

    // Page 5: Your Question Choice
    pages.push(`
        <div class="instruction-container fade-in">
            <h2 class="instruction-title">‚ùì Your Question</h2>
            <p class="instruction-text">Before deciding, you can ask your assistant <strong>ONE</strong> of two questions:</p>
            <div style="display: flex; justify-content: center; gap: 20px; margin: 25px 0; flex-wrap: wrap;">
                <div class="question-btn" style="cursor: default;">
                    "Which vials are <strong style="color: var(--danger-color);">contaminated</strong>?"
                </div>
                <div class="question-btn" style="cursor: default;">
                    "Which vials are <strong style="color: var(--safe-color);">uncontaminated</strong>?"
                </div>
            </div>
            <p class="instruction-text">Think about which question would give you the most useful information for <strong>your goal</strong>.</p>
            <div class="instruction-emphasis">
                You'll complete <strong>1 trial</strong>.
            </div>
        </div>
    `);

    return pages;
}

const instructions = {
    type: jsPsychInstructions,
    pages: getVisualInstructionPages(),
    show_clickable_nav: true,
    button_label_previous: 'Back',
    button_label_next: 'Next',
    data: { trial_type: 'instructions' }
};
timeline.push(instructions);

// -----------------------------------------------------------------------------
// COMPREHENSION CHECKS
// -----------------------------------------------------------------------------

const maxComprehensionAttempts = 3;
let comp1Attempts = 0;
let comp1Passed = false;

// Comprehension check options depend on decision structure
const goalCheckOptionsBase = decisionStructure === 'singleton'
    ? [
        'Find an uncontaminated vial to use',
        'Avoid picking a contaminated vial',
        'Test as many vials as possible',
        'Ask the assistant multiple questions'
    ]
    : [
        'Help Dr. Smith\'s experiment succeed',
        'Help the lab pass the safety inspection',
        'Sort vials as quickly as possible',
        'Ask the assistant multiple questions'
    ];

// The correct answer text (not index, since we'll shuffle)
const goalCheckCorrectAnswer = goalCondition === 'find'
    ? goalCheckOptionsBase[0]
    : goalCheckOptionsBase[1];

// Shuffled options (will be set on_start)
let goalCheckOptionsShuffled = [];

const comprehensionCheck1 = {
    type: jsPsychSurveyMultiChoice,
    questions: function() {
        // Shuffle options each time the check is shown
        goalCheckOptionsShuffled = jsPsych.randomization.shuffle([...goalCheckOptionsBase]);
        return [{
            prompt: '<strong>Comprehension Check 1:</strong> What is your main goal in this task?',
            name: 'goal_check',
            options: goalCheckOptionsShuffled,
            required: true
        }];
    },
    data: { trial_type: 'comprehension_check_1' },
    on_finish: function(data) {
        comp1Attempts++;
        const response = data.response.goal_check;
        data.correct = response === goalCheckCorrectAnswer;
        data.option_order = goalCheckOptionsShuffled;
        comp1Passed = data.correct;
        console.log('Comprehension check 1:', {
            response: response,
            correctAnswer: goalCheckCorrectAnswer,
            isCorrect: data.correct,
            attempts: comp1Attempts
        });
    }
};

const comprehensionFeedback1 = {
    type: jsPsychHtmlButtonResponse,
    stimulus: function() {
        if (comp1Passed) {
            return `<p class="check-correct">‚úì Correct! Let's continue to the next check.</p>`;
        } else {
            const attemptsLeft = maxComprehensionAttempts - comp1Attempts;
            if (attemptsLeft > 0) {
                let reminderText;
                if (decisionStructure === 'singleton') {
                    reminderText = goalCondition === 'find'
                        ? 'find an uncontaminated vial to use'
                        : 'avoid picking a contaminated vial';
                } else {
                    reminderText = goalCondition === 'find'
                        ? 'help Dr. Smith\'s experiment succeed'
                        : 'help the lab pass the safety inspection';
                }
                return `<p class="check-incorrect">That's not quite right.</p>
                        <p>Remember: Your goal is to <strong>${reminderText}</strong>.</p>
                        <p>You have ${attemptsLeft} attempt(s) remaining.</p>`;
            } else {
                return `<p class="check-incorrect">You have exceeded the maximum attempts.</p>
                        <p>Unfortunately, you cannot continue with this study.</p>`;
            }
        }
    },
    choices: function() {
        if (comp1Passed) {
            return ['Continue'];
        } else if (comp1Attempts >= maxComprehensionAttempts) {
            return ['Exit Study'];
        } else {
            return ['Try Again'];
        }
    },
    data: { trial_type: 'comprehension_feedback_1' },
    on_finish: function(data) {
        if (!comp1Passed && comp1Attempts >= maxComprehensionAttempts) {
            jsPsych.endExperiment('Thank you for your time. You did not pass the comprehension checks.');
        }
    }
};

const comprehensionLoop1 = {
    timeline: [comprehensionCheck1, comprehensionFeedback1],
    loop_function: function() {
        return !comp1Passed && comp1Attempts < maxComprehensionAttempts;
    }
};
timeline.push(comprehensionLoop1);

let comp2Attempts = 0;
let comp2Passed = false;

const comp2OptionsBase = [
    'Yes, the assistant knows everything',
    'No, the assistant only has partial information',
    'The assistant knows nothing',
    'It depends on the trial'
];
const comp2CorrectAnswer = 'No, the assistant only has partial information';
let comp2OptionsShuffled = [];

const comprehensionCheck2 = {
    type: jsPsychSurveyMultiChoice,
    questions: function() {
        comp2OptionsShuffled = jsPsych.randomization.shuffle([...comp2OptionsBase]);
        return [{
            prompt: '<strong>Comprehension Check 2:</strong> Does your lab assistant know the status of ALL the vials?',
            name: 'assistant_check',
            options: comp2OptionsShuffled,
            required: true
        }];
    },
    data: { trial_type: 'comprehension_check_2' },
    on_finish: function(data) {
        comp2Attempts++;
        const response = data.response.assistant_check;
        data.correct = response === comp2CorrectAnswer;
        data.option_order = comp2OptionsShuffled;
        comp2Passed = data.correct;
    }
};

const comprehensionFeedback2 = {
    type: jsPsychHtmlButtonResponse,
    stimulus: function() {
        if (comp2Passed) {
            return `<p class="check-correct">‚úì Correct! You're ready to begin.</p>`;
        } else {
            const attemptsLeft = maxComprehensionAttempts - comp2Attempts;
            if (attemptsLeft > 0) {
                return `<p class="check-incorrect">That's not quite right.</p>
                        <p>Remember: The assistant has tested <strong>some but not all</strong> of the vials, so they only have <strong>partial information</strong>.</p>
                        <p>You have ${attemptsLeft} attempt(s) remaining.</p>`;
            } else {
                return `<p class="check-incorrect">You have exceeded the maximum attempts.</p>
                        <p>Unfortunately, you cannot continue with this study.</p>`;
            }
        }
    },
    choices: function() {
        if (comp2Passed) {
            return ['Begin Trial'];
        } else if (comp2Attempts >= maxComprehensionAttempts) {
            return ['Exit Study'];
        } else {
            return ['Try Again'];
        }
    },
    data: { trial_type: 'comprehension_feedback_2' },
    on_finish: function(data) {
        if (!comp2Passed && comp2Attempts >= maxComprehensionAttempts) {
            jsPsych.endExperiment('Thank you for your time. You did not pass the comprehension checks.');
        }
    }
};

const comprehensionLoop2 = {
    timeline: [comprehensionCheck2, comprehensionFeedback2],
    loop_function: function() {
        return !comp2Passed && comp2Attempts < maxComprehensionAttempts;
    }
};
timeline.push(comprehensionLoop2);

// Create trial stimulus
function createTrialStimulus() {
    return `
        <div class="trial-container">
            ${renderVialRack()}
            ${renderProportionBar()}
            <div class="goal-card ${getGoalConfig().cssClass}">
                <span class="icon">${getGoalConfig().icon}</span>
                <span><strong>Your Goal:</strong> ${getGoalConfig().text}</span>
            </div>
            <div class="question-prompt">
                What would you ask your assistant?
            </div>
        </div>
    `;
}

// -----------------------------------------------------------------------------
// MAIN EXPERIMENTAL TRIAL (single trial for exp2)
// -----------------------------------------------------------------------------

let mainTrialButtonOrder = [];

const mainTrial = {
    type: jsPsychHtmlButtonResponse,
    stimulus: createTrialStimulus(),
    choices: questionOptions,
    on_start: function(trial) {
        mainTrialButtonOrder = jsPsych.randomization.shuffle([...questionOptions]);
        trial.choices = mainTrialButtonOrder;
    },
    data: {
        trial_type: 'main_trial',
        trial_id: 'exp2_trial1',
        base_rate: 0.5,
        exp_version: expVersion,
        goal_condition: goalCondition,
        decision_structure: decisionStructure
    },
    on_finish: function(data) {
        data.button_order = [...mainTrialButtonOrder];
        data.chosen_question = mainTrialButtonOrder[data.response];
        data.chose_which_contaminated = data.chosen_question === "Which vials are contaminated?";
        data.chose_which_uncontaminated = data.chosen_question === "Which vials are uncontaminated?";
    },
    button_html: (choice) => `<button class="jspsych-btn" style="min-width: 300px;">${choice}</button>`,
    on_load: disableButtonsTemporarily
};
timeline.push(mainTrial);

// -----------------------------------------------------------------------------
// POST-TASK QUESTIONS
// -----------------------------------------------------------------------------

const strategyProbe = {
    type: jsPsychSurveyText,
    questions: [
        {
            prompt: '<h3>Strategy Question</h3><p>How did you decide which question to ask? Please describe your reasoning or strategy:</p>',
            name: 'strategy',
            rows: 5,
            columns: 60,
            required: true
        }
    ],
    data: { trial_type: 'strategy_probe' }
};
timeline.push(strategyProbe);

// -----------------------------------------------------------------------------
// DEMOGRAPHICS
// -----------------------------------------------------------------------------

const demographics = {
    type: jsPsychSurveyHtmlForm,
    html: `
        <h2>Demographics</h2>
        <p>Please answer the following questions about yourself.</p>

        <div style="margin: 20px 0;">
            <label for="age"><strong>Age:</strong></label><br>
            <input type="number" id="age" name="age" min="18" max="100" required
                   style="padding: 8px; width: 100px; margin-top: 5px;">
        </div>

        <div style="margin: 20px 0;">
            <label><strong>Gender:</strong></label><br>
            <select name="gender" required style="padding: 8px; width: 200px; margin-top: 5px;">
                <option value="">-- Select --</option>
                <option value="female">Female</option>
                <option value="male">Male</option>
                <option value="non-binary">Non-binary</option>
                <option value="other">Other</option>
                <option value="prefer_not">Prefer not to say</option>
            </select>
        </div>

        <div style="margin: 20px 0;">
            <label><strong>Highest level of education completed:</strong></label><br>
            <select name="education" required style="padding: 8px; width: 300px; margin-top: 5px;">
                <option value="">-- Select --</option>
                <option value="high_school">High school or equivalent</option>
                <option value="some_college">Some college</option>
                <option value="associates">Associate's degree</option>
                <option value="bachelors">Bachelor's degree</option>
                <option value="masters">Master's degree</option>
                <option value="doctorate">Doctorate or professional degree</option>
                <option value="other">Other</option>
            </select>
        </div>

        <div style="margin: 20px 0;">
            <label><strong>Is English your native language?</strong></label><br>
            <select name="native_english" required style="padding: 8px; width: 200px; margin-top: 5px;">
                <option value="">-- Select --</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
            </select>
        </div>

        <div style="margin: 20px 0;">
            <label for="native_language"><strong>What is your native language?</strong></label><br>
            <input type="text" id="native_language" name="native_language" required
                   style="padding: 8px; width: 250px; margin-top: 5px;">
        </div>
    `,
    data: { trial_type: 'demographics' }
};
timeline.push(demographics);

// -----------------------------------------------------------------------------
// DEBRIEF
// -----------------------------------------------------------------------------

const debrief = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <h2>Study Complete - Debriefing</h2>
        <div class="instructions-box">
            <p><strong>Thank you for participating!</strong></p>

            <p><strong>Purpose of this study:</strong></p>
            <p>This study investigates how people choose to phrase questions when seeking information.
            Specifically, we are interested in whether people's goals influence which question they ask‚Äîfor example,
            whether asking "Which are contaminated?" vs. "Which are uncontaminated?" depends on what the person
            wants to accomplish.</p>

            <p><strong>What we're studying:</strong></p>
            <p>We hypothesize that people strategically choose question framing to maximize the usefulness of
            the answer for their specific decision problem. Your responses will help us understand the
            cognitive processes underlying question formulation.</p>

            <p><strong>Confidentiality:</strong></p>
            <p>Your responses are completely anonymous and will only be used for research purposes.
            No identifying information has been collected.</p>

            <p>If you have any questions about this research, please contact [researcher email].</p>
        </div>
    `,
    choices: ['Finish and Get Completion Code'],
    data: { trial_type: 'debrief' }
};
timeline.push(debrief);

// =============================================================================
// RUN EXPERIMENT
// =============================================================================

jsPsych.run(timeline);

</script>
</html>
